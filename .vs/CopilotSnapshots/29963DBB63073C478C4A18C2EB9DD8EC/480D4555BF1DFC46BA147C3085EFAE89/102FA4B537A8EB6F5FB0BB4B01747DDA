using Microsoft.AspNetCore.Mvc;
using SPSUL.Models.ViewModels;
using System.Linq;

namespace SPSUL.Controllers
{
    public class DetailController : Controller
    {
        private static readonly List<AssignedTestVm> AssignedMock = Enumerable.Range(1, 42).Select(i => new AssignedTestVm
        {
            Id = i,
            Nazev = $"Test {i}",
            LoginId = $"student{i:000}",
            Jmeno = i % 2 == 0 ? "Jana Nováková" : "Petr Svoboda",
            ZacalV = DateTime.Today.AddDays(-i).AddHours(8),
            DokoncilV = DateTime.Today.AddDays(-i).AddHours(9),
            UspechPct = (i * 7) % 100,
            Absolvoval = i % 3 != 0,
            Aktivni = i % 4 != 0
        }).ToList();

        private static readonly List<TestVm> TestsMock = Enumerable.Range(1, 35).Select(i => new TestVm
        {
            Id = i,
            Nazev = $"Znalosti C# – část {i}",
            PocetOtazek = 10 + (i % 15),
            Vytvoren = DateTime.Today.AddDays(-i),
            Aktivni = i % 5 != 0
        }).ToList();

        public IActionResult Index([FromQuery] DetailIndexViewModel filter)
        {
            // Table 1 filtering + paging
            var a = AssignedMock.AsQueryable();
            if(!string.IsNullOrWhiteSpace(filter.Q1))
            {
                var q = filter.Q1.ToLower();
                a = a.Where(x => x.Nazev.ToLower().Contains(q) || x.Jmeno.ToLower().Contains(q));
            }
            if(filter.Active1.HasValue)
                a = a.Where(x => x.Aktivni == filter.Active1.Value);
            var total1 = a.Count();
            var page1 = Math.Max(1, filter.Page1);
            var size1 = Math.Clamp(filter.PageSize1, 5, 50);
            var items1 = a.OrderByDescending(x=>x.ZacalV).Skip((page1-1)*size1).Take(size1).ToList();

            // Table 2 filtering + paging
            var t = TestsMock.AsQueryable();
            if(!string.IsNullOrWhiteSpace(filter.Q2))
            {
                var q2 = filter.Q2.ToLower();
                t = t.Where(x => x.Nazev.ToLower().Contains(q2));
            }
            if(filter.Active2.HasValue)
                t = t.Where(x => x.Aktivni == filter.Active2.Value);
            var total2 = t.Count();
            var page2 = Math.Max(1, filter.Page2);
            var size2 = Math.Clamp(filter.PageSize2, 5, 50);
            var items2 = t.OrderByDescending(x=>x.Vytvoren).Skip((page2-1)*size2).Take(size2).ToList();

            var vm = new DetailIndexViewModel
            {
                Q1 = filter.Q1,
                Active1 = filter.Active1,
                Page1 = page1,
                PageSize1 = size1,
                Assigned = new PagedResult<AssignedTestVm>{ Items = items1, Page = page1, PageSize = size1, Total = total1 },

                Q2 = filter.Q2,
                Active2 = filter.Active2,
                Page2 = page2,
                PageSize2 = size2,
                Tests = new PagedResult<TestVm>{ Items = items2, Page = page2, PageSize = size2, Total = total2 }
            };

            return View(vm);
        }
    }
}
